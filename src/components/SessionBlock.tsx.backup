import { Session } from '../types';

interface SessionBlockProps {
  session: Session;
  onClick: (e: React.MouseEvent) => void;
}

export default function SessionBlock({ session, onClick }: SessionBlockProps) {
  const duration = (session.endTime.getTime() - session.startTime.getTime()) / (1000 * 60); // in minutes
  const height = Math.max((duration / 60) * 4, 2); // 4rem per hour, minimum 2rem

  const labelColors = [
    'bg-blue-500',
    'bg-green-500',
    'bg-purple-500',
    'bg-pink-500',
    'bg-yellow-500',
    'bg-red-500',
  ];

  const getLabelColor = (label: string) => {
    const hash = label.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    return labelColors[hash % labelColors.length];
  };

  // Calculate estimated content height (in rem)
  // Title: ~1.25rem, Time: ~1rem, Labels: ~1.5rem, Files: ~1rem, Padding/margins: ~1rem
  let estimatedContentHeight = 1.25 + 1; // Title + Time
  if (session.labels.length > 0) estimatedContentHeight += 1.5;
  if (session.files.length > 0) estimatedContentHeight += 1;

  // Robust vertical positioning logic
  let verticalAlignClass = '';
  let paddingClass = 'p-2';

  if (height < 3) {
    // Very small blocks: minimal padding, top-aligned
    verticalAlignClass = 'justify-start';
    paddingClass = 'p-1';
  } else if (height < 6) {
    // Small to medium blocks: use calculated padding for visual centering
    if (estimatedContentHeight < height - 1) {
      // Content fits with room to spare: center it
      verticalAlignClass = 'justify-center';
    } else {
      // Content is tight: top-align with small padding
      verticalAlignClass = 'justify-start';
      paddingClass = 'pt-2 px-2 pb-1';
    }
  } else if (height < 10) {
    // Medium blocks: balance between top visibility and centering
    if (estimatedContentHeight < height - 2) {
      // Plenty of room: center
      verticalAlignClass = 'justify-center';
    } else {
      // Some room: add top padding for visual balance
      verticalAlignClass = 'justify-start';
      paddingClass = 'pt-3 px-2 pb-2';
    }
  } else {
    // Large blocks (multi-hour): always center, plenty of space
    verticalAlignClass = 'justify-center';
    paddingClass = 'p-3';
  }

  return (
    <div
      className={`absolute top-0 left-1 right-1 bg-blue-100 border-l-4 border-blue-500 rounded cursor-pointer hover:shadow-md transition-shadow overflow-hidden z-10 flex flex-col ${verticalAlignClass} ${paddingClass}`}
      style={{ height: `${height}rem` }}
      onClick={onClick}
    >
      <div className="text-sm font-semibold text-gray-900 truncate">{session.title}</div>
      <div className="text-xs text-gray-600 whitespace-nowrap">
        {session.startTime.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        })} - {session.endTime.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        })}
      </div>
      {session.labels.length > 0 && height > 3 && (
        <div className="flex gap-1 mt-1 flex-wrap">
          {session.labels.map((label, idx) => (
            <span
              key={idx}
              className={`text-xs px-1.5 py-0.5 rounded text-white ${getLabelColor(label)}`}
            >
              {label}
            </span>
          ))}
        </div>
      )}
      {session.files.length > 0 && height > 4 && (
        <div className="text-xs text-gray-500 mt-1">
          {session.files.length} file{session.files.length > 1 ? 's' : ''}
        </div>
      )}
    </div>
  );
}
